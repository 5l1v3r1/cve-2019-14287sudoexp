## CVE-2019-14287：sudo权限绕过漏洞分析

0x01: 漏洞简介

有的用户可能知道，如果将sudo配置为允许用户通过Runas规范中定义的ALL关键字来以任意用户身份运行命令的话，那么攻击者将有可能通过制定用户ID -1或4294967295来以root权限执行恶意命令。\*\*

实际上，只要用户的权限足够高，即拥有最高sudo权限的用户，并且在Runas规范中定义了ALL关键字的话，他们就可以运行Runas规范中明确禁止使用的那些root命令，而且以这种方式运行的命令其日志项所显示的目标用户为4294967295，而不是root。与此同时，在执行相应命令的过程中，PAM会话模块将不会运行。

Sudo 的全称是“superuserdo”，它是Linux系统管理指令，允许用户在不需要切换环境的前提下以其它用户的权限运行应用程序或命令。通常以 root 用户身份运行命令，是为了减少 root 用户的登录和管理时间，同时提高安全性。

0x02:利用条件

1） 受影响的Sudo版本

> 版本号 &lt; 1.8.28的Sudo版本均将受到该漏洞的影响。

2）  只有当包含了ALL关键词的sudoer条目存在于Runas规范中时，该漏洞才存在。比如说，如果规范中包含下列sudoer条目的话，目标系统是不会受到该漏洞影响的：

```
alice myhost = /usr/bin/id
```

在上述例子中，alice只能够以root权限运行id命令，任何以不同身份用户运行命令的尝试都将被拒绝。

0x03: 漏洞分析和复现

（一）原理

如果想利用该漏洞来实施攻击，用户需要拥有sudo权限，并允许用户使用任意用户ID来运行命令。通常来说，这意味着用户的sudoer项在Runas规范中定义了特殊的ALL值。

如果sudoer策略允许的话，sudo支持由用户指定的用户名或用户ID来运行命令。比如说，下列sudoer项允许我们以任意用户的身份来运行id命令，因为在Runas规范中它包含了ALL关键字。

```
alice myhost = (ALL) /usr/bin/id
```

除了以任意有效用户的身份运行id命令之外，我们还能够以任意用户ID来运行该命令，此时需要使用\#uid语句：

```
sudo -u#1234 id -u
```

该命令将返回“1234”。但是，sudo可以使用setresuid\(2\)和setreuid\(2\)这两个系统调用来在命令运行之前修改用户ID，并将用户ID修改为-1（或未签名的等价用户ID-4294967295）：

```
sudo -u#-1 id -u
```

或

```
sudo -u#4294967295 id -u
```

上述命令运行之后，将返回“0”。这是因为sudo命令本身已经在以用户ID“0”运行了，所以当sudo尝试将用户ID修改为“-1”时，不会发生任何变化。

但是，sudo日志条目中记录下的命令运行用户的ID为“4294967295”，而并非root用户（或用户ID为“0”），除此之外，因为用户ID是通过-u选项指定的，并且不会在密码数据库中存储，所以PAM会话模块也不会运行。

（二）漏洞利用条件

在/etc/sudoer文件中不含有 非root用户的

bob myhost = \(ALL, !root\) /usr/bin/vi

或者 bob = \(ALL, !root\) /bin/bash

如果不存在，就无法触发漏洞。

![](/png/01.PNG)

或者如果只是在/etc/sudoer里只定义了如下规范：

```
alice myhost = /usr/bin/id
```

那么就只能以root身份运行id命令，除此其它命令都被拒绝。

2）正确的复现

查看/etc/sudoer文件，看看是否有对其它非root用户定义了不同的规范，如果没有，手动添加，目的是构造漏洞触发的条件

查看sudoer版本

sudo -V

1.8.27  属于受影响的版本范围

![](/png/02.PNG)

查看 /etc/sudoers文件

![](/png/04.PNG)

这样就构成了漏洞利用的条件

利用如下：

![](/png/05.PNG)

这样就可以以root 身份去运行bash UID变成了0.

0x04： 修复方法

升级sudo包为最新。

本漏洞鸡肋漏洞，一般情况下 /etc/sudoers里是没有将一般用户添加ALL权限的。



ref:https://www.freebuf.com/vuls/217089.html

